import { Injectable, Logger } from '@nestjs/common';
import { Action, Ctx, Hears, On, Start, Update } from 'nestjs-telegraf';
import type { Context } from 'telegraf';
import { Markup } from 'telegraf';
import { ChatClientService } from '../rmq/chat-client.service';

@Update()
@Injectable()
export class TelegramService {
  private readonly logger = new Logger(TelegramService.name);
  private readonly userStates = new Map<number, 'TEXT' | 'PHOTO'>();

  constructor(private readonly chatClient: ChatClientService) { }

  @Start()
  async onStart(@Ctx() ctx: Context) {
    const caption =
      '–ü—Ä–∏–≤–µ—Ç! –Ø AI-–±–æ—Ç. –í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:\n\n' +
      'üìù –¢–µ–∫—Å—Ç - –æ–±—â–µ–Ω–∏–µ —Å ChatGPT\n' +
      'üé® –§–æ—Ç–æ - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n' +
      'üé• –í–∏–¥–µ–æ - (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)\n' +
      'üéµ –ê—É–¥–∏–æ - (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)\n' +
      'üìä –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è - (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)';

    await ctx.replyWithPhoto(
      { url: 'https://cdn-icons-png.flaticon.com/512/4712/4712035.png' }, // Placeholder logo
      {
        caption,
        ...Markup.inlineKeyboard([
          [Markup.button.callback('üìù –¢–µ–∫—Å—Ç', 'mode_text')],
          [Markup.button.callback('üé® –§–æ—Ç–æ', 'mode_photo')],
          [
            Markup.button.callback('üé• –í–∏–¥–µ–æ', 'mode_video'),
            Markup.button.callback('üéµ –ê—É–¥–∏–æ', 'mode_audio'),
          ],
          [Markup.button.callback('üìä –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è', 'mode_presentation')],
        ]),
      },
    );
  }

  @Action('mode_text')
  async onModeText(@Ctx() ctx: Context) {
    if (ctx.chat?.id) {
      this.userStates.set(ctx.chat.id, 'TEXT');
      await ctx.reply(
        '–†–µ–∂–∏–º: üìù –¢–µ–∫—Å—Ç. –ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.',
        Markup.keyboard([['‚¨ÖÔ∏è –ù–∞–∑–∞–¥']]).resize(),
      );
      await ctx.answerCbQuery();
    }
  }

  @Action('mode_photo')
  async onModePhoto(@Ctx() ctx: Context) {
    if (ctx.chat?.id) {
      this.userStates.set(ctx.chat.id, 'PHOTO');
      await ctx.reply(
        '–†–µ–∂–∏–º: üé® –§–æ—Ç–æ. –û–ø–∏—à–∏, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å.',
        Markup.keyboard([['‚¨ÖÔ∏è –ù–∞–∑–∞–¥']]).resize(),
      );
      await ctx.answerCbQuery();
    }
  }

  @Hears('‚¨ÖÔ∏è –ù–∞–∑–∞–¥')
  async onBack(@Ctx() ctx: Context) {
    if (ctx.chat?.id) {
      this.userStates.delete(ctx.chat.id);
      await ctx.reply('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', Markup.removeKeyboard());
      await this.onStart(ctx);
    }
  }

  @Action(/mode_(video|audio|presentation)/)
  async onModeNotImplemented(@Ctx() ctx: Context) {
    await ctx.reply('–≠—Ç–æ—Ç —Ä–µ–∂–∏–º –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üõ†');
    await ctx.answerCbQuery();
  }

  @Hears(/\/help/)
  async onHelp(@Ctx() ctx: Context) {
    await ctx.reply(
      '–ò—Å–ø–æ–ª—å–∑—É–π /start –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞. –í —Ä–µ–∂–∏–º–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å—ã.',
    );
  }

  @On('text')
  async onMessage(@Ctx() ctx: Context) {
    const text =
      ctx.message && 'text' in ctx.message ? ctx.message.text.trim() : '';
    if (!text) return;

    const chatId = ctx.chat?.id;
    if (!chatId) return;

    const mode = this.userStates.get(chatId) || 'TEXT';

    if (mode === 'PHOTO') {
      await ctx.reply('üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)');
      try {
        await ctx.sendChatAction('upload_photo');
        const response = await this.chatClient.generatePhoto({
          chatId,
          username: ctx.from?.username,
          prompt: text,
        });

        if (response.imageUrl) {
          await ctx.replyWithPhoto(response.imageUrl, {
            caption: `Generated by ${response.model}`,
          });
        } else {
          await ctx.reply('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
        }
      } catch (error) {
        this.logger.error('Failed to generate photo', error);
        await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
      }
    } else {
      try {
        await ctx.sendChatAction('typing');
        const response = await this.chatClient.generateReply({
          chatId,
          username: ctx.from?.username,
          prompt: text,
        });

        await ctx.reply(response.answer);
      } catch (error) {
        this.logger.error('Failed to process message', error);
        await ctx.reply(
          '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.',
        );
      }
    }
  }
}
